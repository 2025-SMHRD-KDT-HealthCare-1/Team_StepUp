<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>StepUp Pushup Pose</title>
    <style>
      body {
        margin: 0;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }
      #container {
        position: relative;
        width: 800px;
        max-width: 100%;
        aspect-ratio: 16 / 9;
      }
      video,
      canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        /* transform: scaleX(-1); ì…€ì¹´ì²˜ëŸ¼ ê±°ìš¸ ëª¨ë“œ (í˜„ì¬ í•´ì œ ìƒíƒœ ìœ ì§€) */
      }
      #overlayUi {
        position: absolute;
        left: 16px;
        top: 16px;
        z-index: 10;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .pill {
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.6);
        font-size: 12px;
      }
    </style>

    <!-- MediaPipe Pose + Camera Utils CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js"></script>
  </head>
  <body>
    <div id="container">
      <video id="video" playsinline></video>
      <canvas id="canvas"></canvas>

      <div id="overlayUi">
        <div class="pill" id="modeInfo">í‘¸ì‰¬ì—… ëª¨ë“œ Â· MediaPipe Pose</div>
        <div class="pill" id="setInfo">ì„¸íŠ¸: 1ì„¸íŠ¸ ì§„í–‰ ì¤‘ (10íšŒ ëª©í‘œ)</div>
        <div class="pill" id="countInfo">ë°˜ë³µ íšŸìˆ˜: 0íšŒ</div>
        <div class="pill" id="statusInfo">ìƒíƒœ: ì¤€ë¹„ ì¤‘...</div>
      </div>
    </div>

    <script>
      const videoEl = document.getElementById("video");
      const canvasEl = document.getElementById("canvas");
      const ctx = canvasEl.getContext("2d");

      const countInfo = document.getElementById("countInfo");
      const statusInfo = document.getElementById("statusInfo");
      const modeInfo = document.getElementById("modeInfo");
      const setInfo = document.getElementById("setInfo");

      let camera = null;

      // ğŸ”¹ ë°˜ë³µ/ì„¸íŠ¸ ì¹´ìš´íŠ¸
      let totalRepCount = 0;
      let repsInCurrentSet = 0;
      let currentSetIndex = 1;

      let goodRepsInSet = 0; // ê¹Šì´ ì¶©ë¶„
      let badRepsInSet = 0; // ì–•ì€ ë™ì‘

      let phase = "up"; // up -> down -> up = 1íšŒ
      let countingEnabled = false;
      let lastRepTime = 0;
      let minAngleThisRep = 999;

      // ğŸ”¹ ê°€ì´ë“œ / ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ìƒíƒœ
      let calibrated = false; // ì¤€ë¹„ìì„¸ í•œ ë²ˆ ë§ì·„ëŠ”ì§€
      let readyPoseFrames = 0; // ì¢‹ì€ ì¤€ë¹„ìì„¸ê°€ ì—°ì†ìœ¼ë¡œ ë‚˜ì˜¨ í”„ë ˆì„ ìˆ˜
      let lostPoseFrames = 0; // í¬ì¦ˆë¥¼ ìƒì–´ë²„ë¦° ì—°ì† í”„ë ˆì„ ìˆ˜

      // ğŸ”¹ ë‚œì´ë„/ëª©í‘œ
      let targetSetsPerDay = 1;
      let targetRepsPerSet = 10;

      // ğŸ”Š ì‹¤ì‹œê°„ ì½”ì¹­ ì¿¨íƒ€ì„
      let lastCoachTime = 0;

      // ğŸ”¹ ê°ë„ ì €ì¥
      let lastAngles = null;

      // ğŸ”¹ íŒ”ê¿ˆì¹˜ ê°ë„(ì„¸íŠ¸ ê¸°ì¤€ ë¶„ì„ìš©)
      let setElbowAngles = [];

      // ğŸ”¹ ì„¸íŠ¸ ì ìˆ˜ (ì˜ìƒ ì—…ë¡œë“œ ì‹œ ê°™ì´ ë„˜ê¸°ê¸°ìš©)
      let lastSetScore = null;

      // íŒ”ê¿ˆì¹˜ ê¸°ì¤€ (í‘¸ì‰¬ì—… ê¹Šì´/í­ íŒë‹¨ìš©)
      const DOWN_ELBOW_MAX = 120; // ì´ ì´í•˜ â†’ ë‚´ë ¤ê°„ ìì„¸
      const UP_ELBOW_MIN = 150; // ì´ ì´ìƒ â†’ ì˜¬ë¼ì˜¨ ìì„¸

      // "ì´ ì •ë„ ê°ë„ë©´ ì ë‹¹"í•œ ë²”ìœ„
      const IDEAL_ELBOW_MIN = 80; // ë„ˆë¬´ ì‘ìœ¼ë©´ íŒ”ì´ ì§€ë‚˜ì¹˜ê²Œ ì ‘í˜
      const IDEAL_ELBOW_MAX = 110; // ë„ˆë¬´ í¬ë©´ íŒ”ì´ ëœ ì ‘í˜

      // ğŸ”¹ ê°€ì´ë“œë¼ì¸ ì´ë¯¸ì§€
      const guideImg = new Image();
      guideImg.src = "guideline_output.png"; // pushup.htmlì´ë‘ ê°™ì€ í´ë”

      function resizeCanvas() {
        const rect = canvasEl.getBoundingClientRect();
        canvasEl.width = rect.width;
        canvasEl.height = rect.height;
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      // ê°€ì´ë“œë¼ì¸ ìœ„ì¹˜/í¬ê¸°
      function getGuideRect() {
        const w = canvasEl.width * 1.0; // ê°€ë¡œ 100%
        const h = canvasEl.height * 0.9; // ì„¸ë¡œ 90%
        const x = (canvasEl.width - w) / 2;
        const y = canvasEl.height - h - 20;
        return { x, y, w, h };
      }

      // ì„¸ ì  a, b, cë¡œ b ê¸°ì¤€ ê°ë„ ê³„ì‚°
      function getAngle(a, b, c) {
        const ab = { x: a.x - b.x, y: a.y - b.y };
        const cb = { x: c.x - b.x, y: c.y - b.y };
        const dot = ab.x * cb.x + ab.y * cb.y;
        const magAB = Math.sqrt(ab.x * ab.x + ab.y * ab.y);
        const magCB = Math.sqrt(cb.x * cb.x + cb.y * cb.y);
        const cos = dot / (magAB * magCB + 1e-6);
        const angle =
          (Math.acos(Math.min(Math.max(cos, -1), 1)) * 180) / Math.PI;
        return angle;
      }

      // ğŸ”¹ í¬ì¦ˆì—ì„œ ì—¬ëŸ¬ ê°ë„ ê³„ì‚°
      function computeAllAngles(landmarks) {
        const leftShoulder = landmarks[11];
        const leftElbow = landmarks[13];
        const leftWrist = landmarks[15];
        const rightShoulder = landmarks[12];
        const rightElbow = landmarks[14];
        const rightWrist = landmarks[16];

        const leftHip = landmarks[23];
        const rightHip = landmarks[24];
        const leftKnee = landmarks[25];
        const rightKnee = landmarks[26];
        const leftAnkle = landmarks[27];
        const rightAnkle = landmarks[28];

        // íŒ”ê¿ˆì¹˜ ê°ë„ (ì–‘ìª½ í‰ê· )
        const leftElbowAngle = getAngle(leftShoulder, leftElbow, leftWrist);
        const rightElbowAngle = getAngle(rightShoulder, rightElbow, rightWrist);
        const elbowAngle = (leftElbowAngle + rightElbowAngle) / 2;

        // ì—‰ë©ì´ ê°ë„: (ì–´ê¹¨ - ì—‰ë©ì´ - ë¬´ë¦)
        let hipAngle = null;
        if (leftHip && rightHip && leftKnee && rightKnee) {
          const leftHipAngle = getAngle(leftShoulder, leftHip, leftKnee);
          const rightHipAngle = getAngle(rightShoulder, rightHip, rightKnee);
          hipAngle = (leftHipAngle + rightHipAngle) / 2;
        }

        // ëª¸ ë¼ì¸ ê°ë„: (ì–´ê¹¨ - ì—‰ë©ì´ - ë°œëª©)
        let bodyStraightAngle = null;
        if (leftHip && rightHip && leftAnkle && rightAnkle) {
          const leftBodyAngle = getAngle(leftShoulder, leftHip, leftAnkle);
          const rightBodyAngle = getAngle(rightShoulder, rightHip, rightAnkle);
          bodyStraightAngle = (leftBodyAngle + rightBodyAngle) / 2;
        }

        return {
          elbow_angle: elbowAngle,
          left_elbow_angle: leftElbowAngle,
          right_elbow_angle: rightElbowAngle,
          hip_angle: hipAngle,
          body_straight_angle: bodyStraightAngle,
        };
      }

      // ğŸ”¹ "í‘¸ì‰¬ì—… ì¤€ë¹„ìì„¸" ì²´í¬ (ë„ˆë¬´ ë¹¡ì„¸ì§€ ì•Šê²Œ)
      function checkPoseReady(landmarks) {
        let minY = 1,
          maxY = 0;
        for (const lm of landmarks) {
          if (lm.visibility !== undefined && lm.visibility < 0.1) continue;
          if (lm.y < minY) minY = lm.y;
          if (lm.y > maxY) maxY = lm.y;
        }
        const heightNorm = maxY - minY;

        // ë„ˆë¬´ ë©€ë¦¬ ìˆì„ ë•Œ ë§‰ê¸°
        const MIN_HEIGHT = 0.15;
        if (heightNorm < MIN_HEIGHT) {
          return {
            ready: false,
            message: "ë„ˆë¬´ ë©€ì–´ìš”. ì¹´ë©”ë¼ ìª½ìœ¼ë¡œ ì¡°ê¸ˆ ë” ë‹¤ê°€ì™€ ì£¼ì„¸ìš”.",
          };
        }

        // ì™„ì „ ì„œ ìˆëŠ” ìì„¸(ì¹´ë©”ë¼ ê½‰ ì°° ì •ë„)ëŠ” ë§‰ê¸°
        const STANDING_HEIGHT = 0.75;
        if (heightNorm > STANDING_HEIGHT) {
          return {
            ready: false,
            message:
              "ì§€ê¸ˆì€ ì„œ ìˆëŠ” ìì„¸ì— ê°€ê¹Œì›Œìš”. ëª¸ì„ ë” ë‚®ì¶°ì„œ í‘¸ì‰¬ì—… ì¤€ë¹„ìì„¸ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.",
          };
        }

        // ìµœì†Œ ê´€ì ˆ ëª‡ ê°œë§Œ ë³´ì´ë©´ OK
        const keyIdx = [11, 13, 15, 23, 25, 27];
        let visibleCnt = 0;
        for (const idx of keyIdx) {
          const lm = landmarks[idx];
          if (lm && (lm.visibility === undefined || lm.visibility > 0.2)) {
            visibleCnt++;
          }
        }

        if (visibleCnt < 3) {
          return {
            ready: false,
            message:
              "ëª¸ ì „ì²´ê°€ í™”ë©´ ì•ˆì— ëŒ€ëµ ë³´ì´ë„ë¡ í•œ ë²ˆë§Œ ë” ì¡°ì •í•´ ì£¼ì„¸ìš”.",
          };
        }

        return { ready: true, message: "ê´€ì ˆ ì¸ì‹ ì–‘í˜¸" };
      }

      // ğŸ”Š ì‹¤ì‹œê°„ ì½”ì¹­ ë©”ì‹œì§€
      function sendRealtimeCoach(mainMessage, detailMessage = "") {
        const now = Date.now();
        const COACH_COOLDOWN = 4000;

        if (now - lastCoachTime < COACH_COOLDOWN) return;
        lastCoachTime = now;

        if (window.parent && window.parent !== window) {
          window.parent.postMessage(
            {
              type: "STEPUP_REALTIME",
              mainMessage,
              detailMessage,
            },
            "*"
          );
        }
      }

      // ğŸ”¹ ê¸°ì¤€ ê°ë„ ë½‘ê¸° (ì •ìì„¸ ìƒ˜í”Œ)
      function exportReferenceAngles() {
        if (!lastAngles) return;

        const payload = {
          type: "PUSHUP_REF_ANGLE",
          timestamp: Date.now(),
          ...lastAngles,
        };

        console.log(JSON.stringify(payload));

        if (window.parent && window.parent !== window) {
          window.parent.postMessage(
            {
              type: "STEPUP_REF_ANGLE",
              angles: payload,
            },
            "*"
          );
        }
      }

      // ğŸ”¹ ì„¸íŠ¸ ë™ì•ˆ íŒ”ê¿ˆì¹˜ ê°ë„ ê¸°ë¡
      function recordElbowAngleForSet(angle) {
        if (!Number.isFinite(angle)) return;
        setElbowAngles.push(angle);
      }

      // ğŸ”¹ ì„¸íŠ¸ ëë‚¬ì„ ë•Œ íŒ”ê¿ˆì¹˜ ê°ë„ ê¸°ë°˜ í”¼ë“œë°±
      function getElbowFeedbackText(angles) {
        if (!angles || angles.length === 0) {
          return "ì´ë²ˆ ì„¸íŠ¸ì—ì„œëŠ” íŒ”ê¿ˆì¹˜ ê°ë„ ë°ì´í„°ë¥¼ ì¶©ë¶„íˆ ì–»ì§€ ëª»í–ˆì–´ìš”. ë‹¤ìŒ ì„¸íŠ¸ì—ì„œëŠ” í™”ë©´ ì¤‘ì•™ì—ì„œ ì¡°ê¸ˆë§Œ ë” ë˜ë ·í•˜ê²Œ ì›€ì§ì—¬ ë³¼ê¹Œìš”?";
        }

        const sum = angles.reduce((acc, v) => acc + v, 0);
        const avg = sum / angles.length;

        if (avg < IDEAL_ELBOW_MIN - 5) {
          return "íŒ”ê¿ˆì¹˜ê°€ ëª¸í†µì— ë„ˆë¬´ ê°€ê¹ê²Œ ë¶™ì–´ ìˆì–´ìš”. ì† ê°„ê²©ì„ ì‚´ì§ ë” ë„“íˆê³ , íŒ”ê¿ˆì¹˜ê°€ ì˜†ìœ¼ë¡œ ì¡°ê¸ˆ ë” ë²Œì–´ì§€ë„ë¡ í•´ ì£¼ì„¸ìš”.";
        }
        if (avg > IDEAL_ELBOW_MAX + 5) {
          return "íŒ”ì´ ì¡°ê¸ˆ ë§ì´ ë²Œì–´ì ¸ ìˆì–´ìš”. ì† ê°„ê²©ì„ ì–´ê¹¨ë„ˆë¹„ ì •ë„ë¡œ ì¢íˆê³ , íŒ”ê¿ˆì¹˜ê°€ ëª¸í†µì—ì„œ 45ë„ ì •ë„ë§Œ ë²Œì–´ì§€ë„ë¡ ë§ì¶° ë³´ì„¸ìš”.";
        }

        return "íŒ”ê¿ˆì¹˜ ê°ë„ëŠ” ì „ë°˜ì ìœ¼ë¡œ ì¢‹ì€ í¸ì´ì—ìš”! ì§€ê¸ˆ ëŠë‚Œì„ ê¸°ì–µí•˜ë©´ì„œ ë‹¤ìŒ ì„¸íŠ¸ë„ ê°™ì€ í­ìœ¼ë¡œ ìœ ì§€í•´ ë³´ì„¸ìš”.";
      }

      // ğŸ”¹ ì„¸íŠ¸ ìš”ì•½ í”¼ë“œë°± (ë¶€ëª¨ Reactë¡œ ì „ì†¡)
      function postSetFeedbackToParent() {
        const total =
          repsInCurrentSet || goodRepsInSet + badRepsInSet || 1;
        const qualityRate = Math.round(
          (goodRepsInSet / (goodRepsInSet + badRepsInSet || 1)) * 100
        );
        const score = qualityRate;
        lastSetScore = score; // âœ… ì˜ìƒ ì—…ë¡œë“œìš©ìœ¼ë¡œ ì €ì¥

        const mainMessage = `${currentSetIndex}ì„¸íŠ¸ (${total}íšŒ) ì™„ë£Œ! ìˆ˜ê³ í•˜ì…¨ì–´ìš” ğŸ‘`;

        const baseSummary = `ì •ìì„¸(ì¢‹ì€ ìì„¸) : ${goodRepsInSet}íšŒ
ë³´ì™„ì´ í•„ìš”í•œ ë™ì‘ : ${badRepsInSet}íšŒ`;

        let detailMessage = "";

        if (badRepsInSet === 0) {
          detailMessage = `${baseSummary}

ì´ë²ˆ ì„¸íŠ¸ì—ì„œëŠ” ê±°ì˜ ëª¨ë“  ë™ì‘ì„ ì•ˆì •ì ì¸ ìì„¸ë¡œ ìˆ˜í–‰í•˜ì…¨ì–´ìš” ğŸ‘
íŒ”ê¿ˆì¹˜ ê°ë„ì™€ ëª¸ì˜ ë¼ì¸ë„ ì „ì²´ì ìœ¼ë¡œ ì˜ ìœ ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.
ì§€ê¸ˆ ëŠë‚Œì„ ê·¸ëŒ€ë¡œ ê¸°ì–µí•´ì„œ ë‹¤ìŒ ì„¸íŠ¸ë„ ê°™ì€ ë¦¬ë“¬ìœ¼ë¡œ ì´ì–´ê°€ ë³¼ê¹Œìš”?`;
        } else {
          const elbowFeedback = getElbowFeedbackText(setElbowAngles);

          detailMessage = `${baseSummary}

${elbowFeedback}
ê°€ìŠ´ì€ ë°”ë‹¥ ìª½ìœ¼ë¡œ ì¡°ê¸ˆ ë” ë‚´ë ¤ê°€ë˜, í—ˆë¦¬ì™€ ì—‰ë©ì´ê°€ ê³¼í•˜ê²Œ êº¼ì§€ì§€ ì•Šë„ë¡
ì–´ê¹¨â€“ì—‰ë©ì´â€“ë°œëª©ì´ í•œ ì¤„ì— ê°€ê¹ê²Œ ìœ ì§€ë˜ëŠ” ëŠë‚Œìœ¼ë¡œ í•´ ì£¼ì„¸ìš”.`;
        }

        if (window.parent && window.parent !== window) {
          window.parent.postMessage(
            {
              type: "STEPUP_FEEDBACK",
              score,
              mainMessage,
              detailMessage,
              reps: total,
            },
            "*"
          );
        }

        statusInfo.textContent = `${currentSetIndex}ì„¸íŠ¸ ì™„ë£Œ! ì ì‹œ í˜¸í¡ì„ ì •ë¦¬í•œ ë’¤ ë‹¤ìŒ ì„¸íŠ¸ë¥¼ ì¤€ë¹„í•´ ì£¼ì„¸ìš”.`;
      }

      // ğŸ” ì˜ëª»ëœ ìì„¸ ì²´í¬(í—ˆë¦¬ êº¼ì§ / ì—‰ë©ì´ ë“¤ë¦¼)
      function checkFormErrors(landmarks, elbowAngle, bodyStraightAngle) {
        const leftShoulder = landmarks[11];
        const rightShoulder = landmarks[12];
        const leftHip = landmarks[23];
        const rightHip = landmarks[24];
        const leftAnkle = landmarks[27];
        const rightAnkle = landmarks[28];

        if (
          !leftShoulder ||
          !rightShoulder ||
          !leftHip ||
          !rightHip ||
          !leftAnkle ||
          !rightAnkle
        ) {
          return;
        }

        // ëª¸ì´ ê±°ì˜ ì¼ì§ì„ ì´ë©´ êµ³ì´ ê²½ê³  ì•ˆ ë„ì›€
        if (!bodyStraightAngle || bodyStraightAngle >= 170) {
          return;
        }

        const shoulderY = (leftShoulder.y + rightShoulder.y) / 2;
        const hipY = (leftHip.y + rightHip.y) / 2;
        const ankleY = (leftAnkle.y + rightAnkle.y) / 2;

        const midBodyY = (shoulderY + ankleY) / 2;
        const diff = hipY - midBodyY;

        // ê¸°ì¤€ ì™„í™”: 0.03 â†’ 0.06
        const THRESH = 0.06;

        const isTopPhase = elbowAngle >= 140;
        if (!isTopPhase) return;

        if (diff > THRESH) {
          sendRealtimeCoach(
            "í—ˆë¦¬ê°€ ì¡°ê¸ˆ ì•„ë˜ë¡œ êº¼ì ¸ ìˆì–´ìš”.",
            "ë°°ì™€ í—ˆë¦¬ë¥¼ ì‚´ì§ ëŒì–´ì˜¬ë ¤ì„œ ì–´ê¹¨ë¶€í„° ë°œê¹Œì§€ê°€ ì¼ì§ì„ ì´ ë˜ë„ë¡ ë§Œë“¤ì–´ ì£¼ì„¸ìš”."
          );
        } else if (diff < -THRESH) {
          sendRealtimeCoach(
            "ì—‰ë©ì´ê°€ ì¡°ê¸ˆ ë„ˆë¬´ ì˜¬ë¼ê°”ì–´ìš”.",
            "ì—‰ë©ì´ë¥¼ ì‚´ì§ ë‚´ë ¤ì„œ ì–´ê¹¨, ì—‰ë©ì´, ë°œëª©ì´ í•œ ì¤„ì´ ë˜ë„ë¡ ë§ì¶°ë³¼ê²Œìš”."
          );
        }
      }

      // ===========================
      // ğŸ¥ ì„¸íŠ¸ ì˜ìƒ ë…¹í™” + ì—…ë¡œë“œ
      // ===========================
      let mediaRecorder = null;
      let recordedChunks = [];
      let isRecording = false;

      let lastUploadSetIndex = null;
      let lastUploadReps = null;
      let lastUploadScore = null;

      let recordingStartedForCurrentSet = false;

      function startRecordingIfPossible() {
        if (isRecording || recordingStartedForCurrentSet) return;

        const stream = videoEl.srcObject;
        if (!stream) {
          console.warn("ğŸ¥ srcObject ì—†ìŒ, ë…¹í™” ì‹œì‘ ë¶ˆê°€");
          return;
        }

        try {
          mediaRecorder = new MediaRecorder(stream, {
            mimeType: "video/webm;codecs=vp8",
          });
        } catch (err) {
          console.error("MediaRecorder ìƒì„± ì‹¤íŒ¨:", err);
          return;
        }

        recordedChunks = [];

        mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            recordedChunks.push(e.data);
          }
        };

        mediaRecorder.onstop = async () => {
          try {
            if (!recordedChunks.length) return;

            const blob = new Blob(recordedChunks, { type: "video/webm" });
            recordedChunks = [];

            const formData = new FormData();
            formData.append("video", blob, "pushup-set.webm");

            // âœ… 5000ë²ˆ í¬íŠ¸ë¡œ í†µì¼
            const res = await fetch(
              "http://localhost:5000/api/upload-video",
              {
                method: "POST",
                body: formData,
              }
            );

            const data = await res.json();
            console.log("ğŸ¥ ì„¸íŠ¸ ì˜ìƒ ì—…ë¡œë“œ ì™„ë£Œ:", data);

            if (window.parent && window.parent !== window) {
              window.parent.postMessage(
                {
                  type: "STEPUP_VIDEO_UPLOADED",
                  setIndex: lastUploadSetIndex,
                  reps: lastUploadReps,
                  score: lastUploadScore,
                  videoUrl: data.videoUrl,
                },
                "*"
              );
            }
          } catch (err) {
            console.error("âŒ ì„¸íŠ¸ ì˜ìƒ ì—…ë¡œë“œ ì‹¤íŒ¨:", err);
          }
        };

        mediaRecorder.start();
        isRecording = true;
        recordingStartedForCurrentSet = true;
        console.log("ğŸ¥ ë…¹í™” ì‹œì‘");
      }

      function stopRecordingAndUpload(setIndex, reps, score) {
        if (!mediaRecorder || !isRecording) return;
        lastUploadSetIndex = setIndex;
        lastUploadReps = reps;
        lastUploadScore = score ?? null;
        isRecording = false;
        mediaRecorder.stop();
        console.log("ğŸ¥ ë…¹í™” ì¤‘ì§€, ì—…ë¡œë“œ ì‹œì‘");
      }

      // ğŸ”¹ ì„¸íŠ¸ ì™„ë£Œ ì²´í¬
      function checkSetComplete() {
        if (repsInCurrentSet >= targetRepsPerSet) {
          const finishedSetIndex = currentSetIndex;
          const finishedReps = repsInCurrentSet;

          // 1) ì„¸íŠ¸ í”¼ë“œë°± (ì ìˆ˜ ê³„ì‚° + lastSetScore ê°±ì‹ )
          postSetFeedbackToParent();

          // 2) ì˜ìƒ ë…¹í™” ì¤‘ì§€ + ì—…ë¡œë“œ
          stopRecordingAndUpload(
            finishedSetIndex,
            finishedReps,
            lastSetScore
          );

          // 3) ë‹¤ìŒ ì„¸íŠ¸ ì¤€ë¹„
          currentSetIndex += 1;
          repsInCurrentSet = 0;
          goodRepsInSet = 0;
          badRepsInSet = 0;
          minAngleThisRep = 999;
          setElbowAngles = [];
          lastSetScore = null;
          recordingStartedForCurrentSet = false;

          calibrated = false;
          readyPoseFrames = 0;

          countInfo.textContent = "ë°˜ë³µ íšŸìˆ˜: 0íšŒ";
          setInfo.textContent = `ì„¸íŠ¸: ${currentSetIndex}ì„¸íŠ¸ ì§„í–‰ ì¤‘ (ì„¸íŠ¸ë‹¹ ${targetRepsPerSet}íšŒ)`;
        }
      }

      // =====================================================
      // onResults : ì›¹ìº  + ê°€ì´ë“œë¼ì¸ + ìŠ¤ì¼ˆë ˆí†¤ + ê·¼ìœ¡ í•˜ì´ë¼ì´íŠ¸
      // =====================================================
      function onResults(results) {
        ctx.save();
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);

        // 1) ì›¹ìº  ì˜ìƒ
        if (results.image) {
          ctx.drawImage(results.image, 0, 0, canvasEl.width, canvasEl.height);
        }

        // 2) ê°€ì´ë“œë¼ì¸ : ì•„ì§ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ ì•ˆëì„ ë•Œë§Œ ë³´ì„
        const guideRect = getGuideRect();
        if (!calibrated && guideImg.complete) {
          ctx.save();
          ctx.globalAlpha = 0.4;
          ctx.drawImage(
            guideImg,
            guideRect.x,
            guideRect.y,
            guideRect.w,
            guideRect.h
          );
          ctx.restore();
        }

        // 3) í¬ì¦ˆ ì¸ì‹
        if (results.poseLandmarks) {
          const landmarks = results.poseLandmarks;
          lostPoseFrames = 0;

          lastAngles = computeAllAngles(landmarks);
          const elbowAngle = lastAngles.elbow_angle;
          const bodyStraight = lastAngles.body_straight_angle ?? 180;

          // ===== 3-1. ê¸°ë³¸ ìŠ¤ì¼ˆë ˆí†¤ =====
          ctx.save();
          ctx.globalAlpha = 0.8;
          window.drawConnectors(ctx, landmarks, window.POSE_CONNECTIONS, {
            color: "#00fff0",
            lineWidth: 2,
          });
          window.drawLandmarks(ctx, landmarks, {
            color: "#ffff66",
            radius: 3,
          });
          ctx.restore();

          // ===== 3-2. ìš´ë™ ë¶€ìœ„ í•˜ì´ë¼ì´íŠ¸ =====
          let depthFactor = (DOWN_ELBOW_MAX + 20 - elbowAngle) / 40;
          depthFactor = Math.max(0, Math.min(1, depthFactor));

          let coreFactor = (bodyStraight - 150) / 30;
          coreFactor = Math.max(0, Math.min(1, coreFactor));

          function highlightBone(i, j) {
            const a = {
              x: landmarks[i].x * canvasEl.width,
              y: landmarks[i].y * canvasEl.height,
            };
            const b = {
              x: landmarks[j].x * canvasEl.width,
              y: landmarks[j].y * canvasEl.height,
            };
            ctx.beginPath();
            ctx.moveTo(a.x, a.y);
            ctx.lineTo(b.x, b.y);
            ctx.stroke();
          }

          if (depthFactor > 0.05) {
            ctx.save();
            ctx.globalAlpha = 0.25 + 0.5 * depthFactor;
            ctx.strokeStyle = "#ff3b3b";
            ctx.lineWidth = 5 + 5 * depthFactor;

            highlightBone(11, 13);
            highlightBone(13, 15);
            highlightBone(12, 14);
            highlightBone(14, 16);

            ctx.restore();
          }

          if (coreFactor > 0.05) {
            ctx.save();
            ctx.globalAlpha = 0.18 + 0.4 * coreFactor;
            ctx.strokeStyle = "#ff7b7b";
            ctx.lineWidth = 4 + 4 * coreFactor;

            const shMid = {
              x: ((landmarks[11].x + landmarks[12].x) / 2) * canvasEl.width,
              y: ((landmarks[11].y + landmarks[12].y) / 2) * canvasEl.height,
            };
            const hipMid = {
              x: ((landmarks[23].x + landmarks[24].x) / 2) * canvasEl.width,
              y: ((landmarks[23].y + landmarks[24].y) / 2) * canvasEl.height,
            };

            ctx.beginPath();
            ctx.moveTo(shMid.x, shMid.y);
            ctx.lineTo(hipMid.x, hipMid.y);
            ctx.stroke();
            ctx.restore();
          }

          // ===== 3-3. ìº˜ë¦¬ë¸Œë ˆì´ì…˜(ì´ˆê¸° ì •ìì„¸ ë§ì¶”ê¸°) =====
          if (!calibrated) {
            const poseInfo = checkPoseReady(landmarks);

            if (!poseInfo.ready) {
              readyPoseFrames = 0;
              statusInfo.textContent = `ìƒíƒœ: ${poseInfo.message}`;
              ctx.restore();
              return;
            }

            const elbowOk = elbowAngle >= 145 && elbowAngle <= 190;
            const bodyOk = bodyStraight >= 165 && bodyStraight <= 195;

            if (elbowOk && bodyOk) {
              readyPoseFrames++;
              statusInfo.textContent =
                "ìƒíƒœ: ì¢‹ìŠµë‹ˆë‹¤! ì ì‹œë§Œ ê·¸ ìì„¸ë¥¼ ìœ ì§€í•´ ì£¼ì„¸ìš”.";

              // ì•½ 2ì´ˆ ìœ ì§€ë˜ë©´ ì¤€ë¹„ ì™„ë£Œ + ì´ ì‹œì ì—ì„œ ë…¹í™” ì‹œì‘
              if (readyPoseFrames >= 60) {
                calibrated = true;
                statusInfo.textContent =
                  "ìƒíƒœ: ì¤€ë¹„ ì™„ë£Œ Â· ì´ì œ ì¹´ìš´íŠ¸ ì‹œì‘í•©ë‹ˆë‹¤!";

                // âœ… ì¹´ìš´íŠ¸ ON ìƒíƒœë¼ë©´, ê°€ì´ë“œë¼ì¸ ì‚¬ë¼ì§€ëŠ” ìˆœê°„ë¶€í„° ì„¸íŠ¸ ë…¹í™” ì‹œì‘
                if (countingEnabled && !isRecording) {
                  console.log("ğŸ¥ ê°€ì´ë“œ ì‚¬ë¼ì§ â†’ ë…¹í™” ì‹œì‘");
                  startRecordingIfPossible();
                }
              }
            } else {
              readyPoseFrames = 0;
              statusInfo.textContent =
                "ìƒíƒœ: ê°€ì´ë“œì— ë§ê²Œ ëª¸ì„ ì¼ì§ì„ ìœ¼ë¡œ ë§ì¶° ì£¼ì„¸ìš”.";
            }

            if (!calibrated) {
              ctx.restore();
              return;
            }
          }

          // ===== 3-4. ì¹´ìš´íŠ¸ / ì½”ì¹­ ë¡œì§ =====
          const leftShoulder = landmarks[11];
          const leftElbow = landmarks[13];
          const leftWrist = landmarks[15];
          const rightShoulder = landmarks[12];
          const rightElbow = landmarks[14];
          const rightWrist = landmarks[16];

          const valid =
            leftShoulder &&
            leftElbow &&
            leftWrist &&
            rightShoulder &&
            rightElbow &&
            rightWrist &&
            leftShoulder.visibility > 0.3 &&
            leftElbow.visibility > 0.3 &&
            leftWrist.visibility > 0.3 &&
            rightShoulder.visibility > 0.3 &&
            rightElbow.visibility > 0.3 &&
            rightWrist.visibility > 0.3;

          if (valid) {
            if (countingEnabled) {
              checkFormErrors(landmarks, elbowAngle, bodyStraight);
            }

            if (!countingEnabled) {
              statusInfo.textContent = `ìƒíƒœ: ì¤€ë¹„ ì™„ë£Œ Â· íŒ”ê¿ˆì¹˜ ${elbowAngle.toFixed(
                1
              )}Â°`;
            } else {
              const now = Date.now();

              const isDownPose = elbowAngle <= DOWN_ELBOW_MAX;
              const isUpPose = elbowAngle >= UP_ELBOW_MIN;

              if (phase === "up" && isDownPose) {
                phase = "down";
                minAngleThisRep = elbowAngle;
                statusInfo.textContent = `ìƒíƒœ: ì•„ë˜ë¡œ ì´ë™ ì¤‘ Â· íŒ”ê¿ˆì¹˜ ${elbowAngle.toFixed(
                  1
                )}Â°`;
              } else if (phase === "down") {
                if (elbowAngle < minAngleThisRep) {
                  minAngleThisRep = elbowAngle;
                }

                if (isUpPose) {
                  if (now - lastRepTime > 500) {
                    phase = "up";
                    lastRepTime = now;

                    totalRepCount += 1;
                    repsInCurrentSet += 1;

                    recordElbowAngleForSet(minAngleThisRep);

                    countInfo.textContent = `ë°˜ë³µ íšŸìˆ˜: ${repsInCurrentSet}íšŒ`;
                    statusInfo.textContent = `ìƒíƒœ: ìœ„(1íšŒ ì™„ë£Œ) Â· íŒ”ê¿ˆì¹˜ ${elbowAngle.toFixed(
                      1
                    )}Â°`;

                    const goodDepth =
                      minAngleThisRep <= DOWN_ELBOW_MAX - 10;
                    if (goodDepth) {
                      goodRepsInSet += 1;
                      exportReferenceAngles();

                      if (Math.random() < 0.3) {
                        sendRealtimeCoach(
                          "ì¢‹ì•„ìš”, ê¹Šì´ ì•„ì£¼ ì¢‹ìŠµë‹ˆë‹¤.",
                          "ì§€ê¸ˆì²˜ëŸ¼ ê°€ìŠ´ì„ ì¶©ë¶„íˆ ë‚´ë ¤ì£¼ë©´ ê°€ìŠ´ê³¼ ì‚¼ë‘ì— ìê·¹ì´ ì˜ ë“¤ì–´ê°‘ë‹ˆë‹¤."
                        );
                      }
                    } else {
                      badRepsInSet += 1;

                      sendRealtimeCoach(
                        "ì¡°ê¸ˆë§Œ ë” ê¹Šê²Œ ë‚´ë ¤ê°€ ë³¼ê¹Œìš”?",
                        "íŒ”ê¿ˆì¹˜ ê°ë„ê°€ ì•„ì§ ì¶©ë¶„íˆ ì ‘íˆì§€ ì•Šì•˜ì–´ìš”. ê°€ìŠ´ì´ ë°”ë‹¥ ìª½ìœ¼ë¡œ ì¡°ê¸ˆ ë” ê°€ê¹Œì›Œì§€ë„ë¡ í•´ ë³´ì„¸ìš”."
                      );
                    }

                    minAngleThisRep = 999;
                    checkSetComplete();
                  }
                } else {
                  statusInfo.textContent = `ìƒíƒœ: ì•„ë˜ ìì„¸ ìœ ì§€ Â· íŒ”ê¿ˆì¹˜ ${elbowAngle.toFixed(
                    1
                  )}Â°`;
                }
              } else {
                statusInfo.textContent = `ìƒíƒœ: ì´ë™ ì¤‘ Â· íŒ”ê¿ˆì¹˜ ${elbowAngle.toFixed(
                  1
                )}Â°`;
              }
            }
          } else {
            statusInfo.textContent = "ìƒíƒœ: ìì„¸ ì¸ì‹ ì¤‘...";
          }
        } else {
          // í¬ì¦ˆ ìì²´ê°€ ì—†ëŠ” í”„ë ˆì„
          lostPoseFrames++;

          if (calibrated && lostPoseFrames > 60) {
            calibrated = false;
            readyPoseFrames = 0;
            recordingStartedForCurrentSet = false;
            statusInfo.textContent =
              "ìƒíƒœ: ìì„¸ê°€ ì˜¤ë˜ ì¸ì‹ë˜ì§€ ì•Šì•˜ì–´ìš”. ê°€ì´ë“œì— ë‹¤ì‹œ ë§ì¶° ì£¼ì„¸ìš”.";
          } else if (!calibrated) {
            statusInfo.textContent = "ìƒíƒœ: ìì„¸ ì¸ì‹ ì¤‘ ...";
          }
        }

        ctx.restore();
      }

      // MediaPipe Pose ì„¸íŒ…
      const pose = new window.Pose({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${file}`,
      });

      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        enableSegmentation: false,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
      });

      pose.onResults(onResults);

      // ğŸ”¹ ì¹´ë©”ë¼ë§Œ ì¼œëŠ” í•¨ìˆ˜
      async function startCameraInternal() {
        if (camera) {
          console.log("ğŸ“· ì´ë¯¸ ì¹´ë©”ë¼ê°€ ì‹œì‘ë¨");
          return;
        }

        statusInfo.textContent = "ìƒíƒœ: ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...";

        try {
          camera = new window.Camera(videoEl, {
            onFrame: async () => {
              await pose.send({ image: videoEl });
            },
            width: 640,
            height: 360,
          });

          await camera.start();
          statusInfo.textContent = "ìƒíƒœ: ì¸ì‹ ì¤‘...";
          console.log("âœ… ì¹´ë©”ë¼ ì‹œì‘ ì„±ê³µ");
        } catch (err) {
          console.error("âŒ ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:", err);
          statusInfo.textContent =
            "ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš” (ì£¼ì†Œì°½ì˜ ì¹´ë©”ë¼ ì•„ì´ì½˜).";
          alert(
            "ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì˜¤ë¥¸ìª½ì˜ ì¹´ë©”ë¼ ì•„ì´ì½˜ì—ì„œ 'í—ˆìš©'ìœ¼ë¡œ ë°”ê¿”ì£¼ì„¸ìš”."
          );
        }
      }

      // ğŸ”¹ ì¹´ìš´íŠ¸ ìƒíƒœ ì´ˆê¸°í™” + ì¹´ìš´íŠ¸ ON
      function startCounting() {
        countingEnabled = true;
        phase = "up";
        totalRepCount = 0;
        repsInCurrentSet = 0;
        currentSetIndex = 1;
        goodRepsInSet = 0;
        badRepsInSet = 0;
        lastRepTime = 0;
        minAngleThisRep = 999;
        lastAngles = null;
        setElbowAngles = [];
        lastSetScore = null;

        calibrated = false;
        readyPoseFrames = 0;
        lostPoseFrames = 0;

        recordingStartedForCurrentSet = false;
        isRecording = false;
        mediaRecorder = null;
        recordedChunks = [];

        countInfo.textContent = "ë°˜ë³µ íšŸìˆ˜: 0íšŒ";
        setInfo.textContent = `ì„¸íŠ¸: ${currentSetIndex}ì„¸íŠ¸ ì§„í–‰ ì¤‘ (ì„¸íŠ¸ë‹¹ ${targetRepsPerSet}íšŒ)`;
        statusInfo.textContent = "ìƒíƒœ: ì¸ì‹ ì¤‘...";

        if (window.parent && window.parent !== window) {
          window.parent.postMessage(
            {
              type: "STEPUP_REALTIME",
              mainMessage: `${currentSetIndex}ì„¸íŠ¸ ì‹œì‘í•©ë‹ˆë‹¤. ì²œì²œíˆ ì²« ë™ì‘ì„ ë‚´ë ¤ê°€ ë³¼ê¹Œìš”?`,
              detailMessage: "",
            },
            "*"
          );
        }
      }

      // ğŸ”¹ Reactì—ì„œ ì§ì ‘ í˜¸ì¶œí•  ìˆ˜ ìˆê²Œ ì „ì—­ ë…¸ì¶œ
      window.startCamera = function () {
        startCounting();
        startCameraInternal();
      };

      // âœ… ë¶„ì„ ì¤‘ì§€(ì¤‘ê°„ STOP) ì²˜ë¦¬ìš© í•¨ìˆ˜
      function stopAnalysisNow() {
        console.log("â¹ ìˆ˜ë™ ë¶„ì„ ì¤‘ì§€ ìš”ì²­");
        // ë” ì´ìƒ ì¹´ìš´íŠ¸/ì½”ì¹­ ì•ˆ í•˜ë„ë¡
        countingEnabled = false;

        // ë…¹í™” ì¤‘ì´ë©´ ì§€ê¸ˆê¹Œì§€ ì˜ìƒ ì—…ë¡œë“œ
        if (isRecording) {
          const finishedSetIndex = currentSetIndex;
          const finishedReps = repsInCurrentSet;
          const finishedScore = lastSetScore;

          stopRecordingAndUpload(
            finishedSetIndex,
            finishedReps,
            finishedScore
          );
        }

        statusInfo.textContent = "ìƒíƒœ: ë¶„ì„ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.";
      }

      // ğŸ”¹ React(Pose.jsx)ì—ì„œ ë³´ë‚´ëŠ” ë©”ì‹œì§€ ì²˜ë¦¬
      window.addEventListener("message", (event) => {
        if (!event.data || typeof event.data !== "object") return;
        const { type } = event.data;

        if (type === "STEPUP_START_CAMERA") {
          console.log("â–¶ STEPUP_START_CAMERA ìˆ˜ì‹ ");
          startCounting();
          startCameraInternal();
        }

        if (type === "STEPUP_SET_TARGET") {
          console.log("ğŸ¯ ëª©í‘œ ì„¸íŒ…:", event.data);
          targetSetsPerDay = event.data.setsPerDay ?? targetSetsPerDay;
          targetRepsPerSet = event.data.repsPerSet ?? targetRepsPerSet;

          setInfo.textContent = `ì„¸íŠ¸: ${currentSetIndex}ì„¸íŠ¸ ì§„í–‰ ì¤‘ (ì„¸íŠ¸ë‹¹ ${targetRepsPerSet}íšŒ)`;
          modeInfo.textContent = `í‘¸ì‰¬ì—… ëª¨ë“œ Â· ëª©í‘œ: ${targetSetsPerDay}ì„¸íŠ¸ Ã— ${targetRepsPerSet}íšŒ`;
        }

        // âœ… Pose.jsxì—ì„œ ì˜¤ëŠ” "ë¶„ì„ ì¤‘ì§€" ëª…ë ¹ ì²˜ë¦¬
        if (type === "STEPUP_STOP_ANALYSIS") {
          console.log("â¹ STEPUP_STOP_ANALYSIS ìˆ˜ì‹ ");
          stopAnalysisNow();
        }
      });
    </script>
  </body>
</html>